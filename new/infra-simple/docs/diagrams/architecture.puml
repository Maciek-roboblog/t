@startuml architecture
!theme plain
skinparam backgroundColor white
skinparam defaultFontName Helvetica
skinparam roundCorner 8
skinparam shadowing false

skinparam rectangle {
    BackgroundColor<<external>> #F3E5F5
    BorderColor<<external>> #7B1FA2
    BackgroundColor<<k8s>> #E3F2FD
    BorderColor<<k8s>> #1976D2
    BackgroundColor<<storage>> #E8F5E9
    BorderColor<<storage>> #388E3C
}

skinparam component {
    BackgroundColor #FFFFFF
    BorderColor #616161
}

title LLaMA-Factory - System Architecture

rectangle "External Services" <<external>> {
    database "MLflow" as mlflow
    component "vLLM Server\n:8000" as vllm
}

rectangle "NFS Storage (ReadWriteMany)" <<storage>> {
    storage "/models/base" as base
    storage "/models/merged" as merged
    storage "/output/lora" as lora
    storage "/data" as data
}

rectangle "Kubernetes (GPU Nodes)" <<k8s>> {
    package "llm-training" {
        component "WebUI\n:7860" as webui
        component "Training Job" as train
        component "Merge Job" as merge
    }
}

' Training flow
base --> train : read
data --> train : dataset
train --> lora : LoRA adapter
train ..> mlflow : metrics

' Merge flow
base --> merge : read
lora --> merge : read
merge --> merged : write

' Inference
merged --> vllm : read model

note right of vllm
  External service
  Reads from NFS
end note

@enduml
